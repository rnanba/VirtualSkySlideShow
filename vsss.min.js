function VirtualSkySlideShow(opt){this.pause=!0,this.show=!1,this.moving=!1,this.startId=0,this.clockMove={},this.azMove={},this.RA_REGEXP=/^\s*(\d+)h\s*(\d+)m\s*(\d+(\.\d+)?)s\s*$/,this.DEC_REGEXP=/^\s*([+-]?\d+)[°º]\s*(\d+)['′]\s*(\d+(\.\d+)?)["″]?\s*$/,this.PLANET_INDEX={Mercury:0,Venus:1,Mars:2,Jupiter:3,Saturn:4,Uranus:5,Neptune:6},this.config={},this.slides=null,this.slideIndex=0,this.quick_with_key=opt.quick_with_key,this.id=opt.id,this.url=opt.url,this.data=opt.data,delete opt.url,delete opt.data,delete opt.quick_with_key;var ss=this;for(var key in popt={projection:"stereo",constellations:!0,showplanets:!0,showplanetlabels:!1,showdate:!0,scalestars:1.5,mouse:!0,keyboard:!1,callback:{click:function(e){document.getElementById(ss.id).focus(),ss.pause=!ss.pause,ss.pause||(ss.slideIndex<0||ss.slides.length<=ss.slideIndex?ss.startSlideShow():ss.show&&ss.start())}}},opt)popt[key]=opt[key];S("head").append('<style type="text/css">.'+popt.id+"_btn_help { display: none !important; } #"+popt.id+".fullscreen {  width: 100vw !important;  height: 100vh !important;}</style>");var elm=document.getElementById(ss.id);elm.setAttribute("tabindex","-1");var maxWidth=document.documentElement.clientWidth-elm.getBoundingClientRect().left,width=elm.clientWidth,height=elm.clientHeight;if(maxWidth<width){var scale=maxWidth/width;width=maxWidth,height*=scale,elm.style.backgroundSize=width+"px"}elm.style.width=width+"px",elm.style.height=height+"px";var src=this.url?this.url:this.data;return this.loadSlides(src,function(){ss.config.latitude&&(popt.latitude=ss.config.latitude),ss.config.longitude&&(popt.longitude=ss.config.longitude),ss.config.date&&(popt.clock=new Date(ss.config.date)),ss.config.az&&(popt.az=ss.config.az),ss.planetarium=S.virtualsky(popt),ss.planetarium.showhelp=!1,ss.planetarium.credit=!1,ss.planetarium.draw(),elm.addEventListener("keydown",function(e){switch(e.keyCode){case 39:case 78:ss.pause=!0,ss.forward();break;case 37:case 80:ss.pause=!0,ss.backward();break;case 36:case 188:ss.pause=!0,ss.beginning();break;case 35:case 190:ss.pause=!0,ss.end()}})}),this}VirtualSkySlideShow.prototype.moveToClock=function(date,duration,onEnd){this.planetarium.spin=!1,this.clockMove={duration:duration,start:new Date,from:this.planetarium.clock,to:date,onEnd:onEnd},this.moveClockStep()},VirtualSkySlideShow.prototype.moveClockStep=function(){var t=(new Date-this.clockMove.start)/this.clockMove.duration,time=this.clockMove.from.getTime()+(this.clockMove.to.getTime()-this.clockMove.from.getTime())*t;if(this.planetarium.updateClock(new Date(time)),t<1){this.planetarium.drawImmediate();var _obj=this;requestAnimFrame(function(){_obj.moveClockStep()})}else this.planetarium.updateClock(this.clockMove.to),this.planetarium.trigger("loadedPlanets"),this.planetarium.drawImmediate(),this.clockMove.onEnd&&this.clockMove.onEnd()},VirtualSkySlideShow.prototype.moveToAz=function(az,duration,onEnd){var to=az%360-180,d=to-this.planetarium.az_off;d>180?to-=360:d<-180&&(to+=360),this.azMove={duration:duration,start:new Date,from:this.planetarium.az_off,to:to,onEnd:onEnd},this.moveAzStep()},VirtualSkySlideShow.prototype.moveAzStep=function(){var t=(new Date-this.azMove.start)/this.azMove.duration;if(this.planetarium.az_off=this.azMove.from+(this.azMove.to-this.azMove.from)*t,t<1){this.planetarium.drawImmediate();var _obj=this;requestAnimFrame(function(){_obj.moveAzStep()})}else this.planetarium.az_off=this.azMove.to,this.planetarium.drawImmediate(),this.azMove.onEnd&&this.azMove.onEnd()},VirtualSkySlideShow.prototype.moveToRADec=function(ra,dec,label,duration,onEnd){if("string"==typeof ra){var f=this.RA_REGEXP.exec(ra);ra=15*parseInt(f[1],10)+15*parseInt(f[2],10)/60+15*parseFloat(f[3])/60/60}if("string"==typeof dec){f=this.DEC_REGEXP.exec(dec);dec=parseInt(f[1],10)+1*parseInt(f[2],10)/60+1*parseFloat(f[3])/60/60}var horizon=this.planetarium.coord2horizon(ra*this.planetarium.d2r,dec*this.planetarium.d2r);this.planetarium.pointers=[],this.planetarium.addPointer({ra:ra,dec:dec,label:label}),this.moveToAz(horizon[1]*this.planetarium.r2d,duration,onEnd)},VirtualSkySlideShow.prototype.moveToPlanet=function(name,label,duration,onEnd){var ra,dec;if("Sun"===name)ra=this.planetarium.lookup.sun[0].ra*this.planetarium.r2d,dec=this.planetarium.lookup.sun[0].dec*this.planetarium.r2d;else if("Moon"===name)ra=this.planetarium.lookup.moon[0].ra*this.planetarium.r2d,dec=this.planetarium.lookup.moon[0].dec*this.planetarium.r2d;else{var i=this.PLANET_INDEX[name];ra=this.planetarium.lookup.planet[i].ra*this.planetarium.r2d,dec=this.planetarium.lookup.planet[i].dec*this.planetarium.r2d}this.moveToRADec(ra,dec,label,duration,onEnd)},VirtualSkySlideShow.prototype.loadImage=function(url){this.planetarium.container.css({"background-image":'url("'+url+'")'})},VirtualSkySlideShow.prototype.showImage=function(url){var css={"background-color":"black","background-image":'url("'+url+'")',"background-position":"center","background-repeat":"no-repeat","background-size":"contain"};this.planetarium.container.css(css),this.planetarium.canvas.css({transition:"opacity 0.5s ease-in-out"}),this.planetarium.canvas.css({opacity:"0"}),this.show=!0},VirtualSkySlideShow.prototype.hideImage=function(){this.planetarium.canvas.css({opacity:"1"}),this.show=!1},VirtualSkySlideShow.prototype.nextSlide=function(startId,quick){this.slideIndex>=this.slides.length||(this.quick=quick,this.slideIndex++,this.slides.length<=this.slideIndex&&(this.pause=!0),this.moving||this.showSlide(startId,this.slideIndex,quick))},VirtualSkySlideShow.prototype.prevSlide=function(startId,quick){this.slideIndex<0||(this.quick=quick,this.slideIndex--,this.slideIndex<0&&(this.pause=!0),this.moving||this.showSlide(startId,this.slideIndex,quick))},VirtualSkySlideShow.prototype.showSlide=function(startId,index,quick){var ss=this,slide=ss.slides[index];if(slide){var pan_duration=quick?50:ss.config.pan_duration,spin_duration=quick?50:ss.config.spin_duration,stop_duration=quick?10:ss.config.stop_duration,next=function(){ss.showing=!1,ss.pause||ss.startId!=startId||ss.nextSlide(startId,!1)},show=function(){ss.moving=!1,setTimeout(function(){if(index!=ss.slideIndex){var lastIndex=ss.slides.length-1;index>0&&ss.slideIndex<0?ss.showSlide(ss.startId,0,ss.quick):index<lastIndex&&ss.slideIndex>lastIndex?ss.showSlide(ss.startId,lastIndex,ss.quick):ss.showSlide(ss.startId,ss.slideIndex,ss.quick)}else ss.showImage(slide.image),ss.pause||setTimeout(next,ss.config.image_duration)},stop_duration)},pan=function(){slide.planet?ss.moveToPlanet(slide.planet,slide.label,pan_duration,show):ss.moveToRADec(slide.ra,slide.dec,slide.label,pan_duration,show)},spin=function(){ss.loadImage(slide.image),ss.planetarium.pointers=[],ss.moveToClock(new Date(slide.date),spin_duration,pan)},waitandgo=function(){setTimeout(spin,stop_duration)};ss.moving=!0,ss.show?(setTimeout(waitandgo,500),ss.hideImage()):waitandgo()}else ss.show&&ss.hideImage()},VirtualSkySlideShow.prototype.loadSlides=function(src,onLoad){var ss=this;"string"==typeof src?S(document).ajax(src,{dataType:"json",success:function(data){ss.init(data),onLoad&&onLoad()},complete:function(){},error:function(e){console.log("load error: "+e)}}):(ss.init(data),onLoad&&onLoad())},VirtualSkySlideShow.prototype.init=function(data){this.config=data.config,this.slides=data.slides,this.slideIndex=-1},VirtualSkySlideShow.prototype.resetSlideShow=function(){this.planetarium.setLatitude(this.config.latitude),this.planetarium.setLongitude(this.config.longitude),this.planetarium.updateClock(new Date(this.config.date)),this.planetarium.az_off=this.config.az%360-180,this.planetarium.drawImmediate(),this.slideIndex=-1},VirtualSkySlideShow.prototype.startSlideShow=function(){this.resetSlideShow(),this.start()},VirtualSkySlideShow.prototype.renewStartId=function(){var oldId=this.startId;this.startId++,this.startId==oldId&&(this.startId=0)},VirtualSkySlideShow.prototype.start=function(){this.renewStartId(),this.nextSlide(this.startId,!1)},VirtualSkySlideShow.prototype.forward=function(){this.renewStartId(),this.nextSlide(this.startId,this.quick_with_key)},VirtualSkySlideShow.prototype.backward=function(){this.renewStartId(),this.prevSlide(this.startId,this.quick_with_key)},VirtualSkySlideShow.prototype.beginning=function(){this.renewStartId(),this.slideIndex=-1,this.showSlide(this.startId,0,this.quick)},VirtualSkySlideShow.prototype.end=function(){this.renewStartId(),this.slideIndex=this.slides.length,this.showSlide(this.startId,this.slides.length-1,this.quick)};