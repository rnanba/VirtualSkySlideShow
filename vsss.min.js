function VirtualSkySlideShow(opt){this.version="0.5.0",this.pause=!0,this.show=!1,this.moving=!1,this.startId=0,this.clockMove={},this.azMove={},this.posMove={},this.RA_REGEXP=/^\s*(\d+)h\s*(\d+)m\s*(\d+(\.\d+)?)s\s*$/,this.DEC_REGEXP=/^\s*([+-]?\d+)[°º]\s*(\d+)['′]\s*(\d+(\.\d+)?)["″]?\s*$/,this.PLANET_INDEX={Mercury:0,Venus:1,Mars:2,Jupiter:3,Saturn:4,Uranus:5,Neptune:6},this.config={},this.slides=null,this.slideIndex=0,this.quick_with_key=opt.quick_with_key,this.id=opt.id,this.url=opt.url,this.data=opt.data,this.video=null,this.zoomview=null,this.zoomviewImage=null,this.zoomMode=!1,this.wzoom=null,this.currentZoom=0,this.captureKey=!0,delete opt.url,delete opt.data,delete opt.quick_with_key;var key,ss=this;for(key in popt={projection:"stereo",constellations:!0,showplanets:!0,showplanetlabels:!1,showdate:!0,scalestars:1.5,mouse:!0,keyboard:!1,callback:{click:function(e){document.getElementById(ss.id).focus(),ss.pause=!ss.pause,ss.pause||(ss.slideIndex<0||ss.slides.length<=ss.slideIndex?ss.startSlideShow():ss.show&&ss.start())}}},opt)popt[key]=opt[key];S("head").append('<style type="text/css">.'+popt.id+"_btn_help { display: none !important; } #"+popt.id+".fullscreen {  width: 100vw !important;  height: 100vh !important;}</style>");var elm=document.getElementById(ss.id),img=(elm.setAttribute("tabindex","-1"),document.createElement("img")),zoomview=(img.setAttribute("id","zoomview_image"),img.draggable=!1,document.createElement("div")),img=(zoomview.setAttribute("id","zoomview"),zoomview.style.setProperty("position","absolute"),zoomview.style.setProperty("top","0"),zoomview.style.setProperty("left","0"),zoomview.style.setProperty("width","100vw"),zoomview.style.setProperty("height","100vh"),zoomview.style.setProperty("background-color","black"),zoomview.style.setProperty("display","flex"),zoomview.style.setProperty("align-items","center"),zoomview.style.setProperty("justify-content","center"),zoomview.style.setProperty("visibility","hidden"),zoomview.append(img),ss.zoomview=zoomview,ss.zoomviewImage=img,document.body.append(zoomview),ss.zoomview=zoomview,ss.wzoom=WZoom.create("#zoomview_image",{maxScale:2,smoothTime:0,rescale:function(wz){ss.zoomMode&&wz.content.currentScale==wz.content.minScale&&ss.currentZoom==wz.content.minScale&&(ss.currentZoom=0,ss.endZoom()),ss.currentZoom=wz.content.currentScale,wz.options.smoothTime=.1},prepare:function(wz){wz.options.smoothTime=0}}),ss.zoomview.setAttribute("tabindex","-1"),ss.captureKey||ss.zoomview.addEventListener("keydown",ss.handleKey),window.addEventListener("resize",()=>{null!=ss.wzoom&&ss.wzoom.prepare()}),ss.resize(),this.url||this.data);return this.loadSlides(img,function(){ss.config.latitude&&(popt.latitude=ss.config.latitude),ss.config.longitude&&(popt.longitude=ss.config.longitude),ss.config.date&&(popt.clock=new Date(ss.config.date)),ss.config.az&&(popt.az=ss.config.az),ss.planetarium=S.virtualsky(popt),ss.planetarium.showhelp=!1,ss.planetarium.credit=!1,ss.planetarium.draw(),ss.captureKey||elm.addEventListener("keydown",ss.handleKey),elm.addEventListener("wheel",ss.handleWheel)}),document.addEventListener("fullscreenchange",function(){var vs=ss.planetarium;fullScreenApi.isFullScreen()?vs.fullscreen||(vs.fullscreen=!0,vs.container.addClass("fullscreen")):vs.fullscreen&&(vs.fullscreen=!1,vs.container.removeClass("fullscreen"))}),ss.captureKey&&window.addEventListener("keydown",ss.handleKey),window.addEventListener("resize",function(){ss.resize()}),this}VirtualSkySlideShow.prototype.moveToClock=function(date,duration,onEnd){this.planetarium.spin=!1,this.clockMove={duration:duration,start:new Date,from:this.planetarium.clock,to:date,onEnd:onEnd},this.moveClockStep()},VirtualSkySlideShow.prototype.moveClockStep=function(){var _obj,t=(new Date-this.clockMove.start)/this.clockMove.duration,time=this.clockMove.from.getTime()+(this.clockMove.to.getTime()-this.clockMove.from.getTime())*t;this.planetarium.updateClock(new Date(time)),t<1?(this.planetarium.drawImmediate(),_obj=this,requestAnimFrame(function(){_obj.moveClockStep()})):(this.planetarium.updateClock(this.clockMove.to),this.planetarium.trigger("loadedPlanets"),time=this.planetarium.moonPos(this.planetarium.times.JD),this.planetarium.moon=time.moon,this.planetarium.sun=time.sun,this.planetarium.drawImmediate(),this.clockMove.onEnd&&this.clockMove.onEnd())},VirtualSkySlideShow.prototype.moveToAz=function(az,duration,onEnd){var az=az%360-180,d=az-this.planetarium.az_off;180<d?az-=360:d<-180&&(az+=360),this.azMove={duration:duration,start:new Date,from:this.planetarium.az_off,to:az,onEnd:onEnd},this.moveAzStep()},VirtualSkySlideShow.prototype.moveAzStep=function(){var _obj,t=(new Date-this.azMove.start)/this.azMove.duration;this.planetarium.az_off=this.azMove.from+(this.azMove.to-this.azMove.from)*t,t<1?(this.planetarium.drawImmediate(),_obj=this,requestAnimFrame(function(){_obj.moveAzStep()})):(this.planetarium.az_off=this.azMove.to,this.planetarium.drawImmediate(),this.azMove.onEnd&&this.azMove.onEnd())},VirtualSkySlideShow.prototype.moveToRADec=function(ra,dec,label,duration,onEnd){"string"==typeof ra&&((f=this.RA_REGEXP.exec(ra))?ra=15*parseInt(f[1],10)+15*parseInt(f[2],10)/60+15*parseFloat(f[3])/60/60:console.log("ERROR: ra = "+ra)),"string"==typeof dec&&((f=this.DEC_REGEXP.exec(dec))?dec=parseInt(f[1],10)+ +parseInt(f[2],10)/60+ +parseFloat(f[3])/60/60:console.log("ERROR: dec = "+dec));var f=this.planetarium.coord2horizon(ra*this.planetarium.d2r,dec*this.planetarium.d2r);this.planetarium.pointers=[],this.planetarium.addPointer({ra:ra,dec:dec,label:label}),this.moveToAz(f[1]*this.planetarium.r2d,duration,onEnd)},VirtualSkySlideShow.prototype.moveToPlanet=function(name,label,duration,onEnd){var ra;name="Sun"===name?(ra=this.planetarium.lookup.sun[0].ra*this.planetarium.r2d,this.planetarium.lookup.sun[0].dec*this.planetarium.r2d):"Moon"===name?(ra=this.planetarium.lookup.moon[0].ra*this.planetarium.r2d,this.planetarium.lookup.moon[0].dec*this.planetarium.r2d):(name=this.PLANET_INDEX[name],ra=this.planetarium.lookup.planet[name].ra*this.planetarium.r2d,this.planetarium.lookup.planet[name].dec*this.planetarium.r2d),this.moveToRADec(ra,name,label,duration,onEnd)},VirtualSkySlideShow.prototype.moveToPos=function(latitude,longitude,duration,onEnd){this.posMove={duration:duration,start:new Date,from:{latitude:this.planetarium.latitude.deg,longitude:this.planetarium.longitude.deg},to:{latitude:latitude,longitude:longitude},onEnd:onEnd},this.movePosStep()},VirtualSkySlideShow.prototype.movePosStep=function(){var lat,ss,t=(new Date-this.posMove.start)/this.posMove.duration;t<1?(lat=this.posMove.from.latitude+(this.posMove.to.latitude-this.posMove.from.latitude)*t,t=this.posMove.from.longitude+(this.posMove.to.longitude-this.posMove.from.longitude)*t,this.planetarium.setLatitude(lat),this.planetarium.setLongitude(t),this.planetarium.updateClock(this.planetarium.clock),this.planetarium.drawImmediate(),ss=this,requestAnimFrame(function(){ss.movePosStep()})):(this.planetarium.setLatitude(this.posMove.to.latitude),this.planetarium.setLongitude(this.posMove.to.longitude),this.planetarium.updateClock(this.planetarium.clock),this.planetarium.drawImmediate(),this.posMove.onEnd&&this.posMove.onEnd())},VirtualSkySlideShow.prototype.loadImage=function(url){this.planetarium.container.css({"background-image":'url("'+url+'")'}),ss.loaded="image"},VirtualSkySlideShow.prototype.loadVideo=function(url,posterUrl){var resizeVideoWrapper,ss=this,container=ss.planetarium.container.e[0],canvas=ss.planetarium.canvas.e[0];ss.videoWrapper||(ss.videoWrapper=document.createElement("div"),ss.videoWrapper.style.setProperty("text-align","center"),ss.videoWrapper.style.setProperty("position","absolute"),resizeVideoWrapper=function(){var cw=canvas.style.getPropertyValue("width"),ch=canvas.style.getPropertyValue("height");ss.videoWrapper.style.setProperty("width",cw),ss.videoWrapper.style.setProperty("height",ch)},window.addEventListener("resize",resizeVideoWrapper),document.addEventListener("fullscreenchange",resizeVideoWrapper),container.prepend(ss.videoWrapper),resizeVideoWrapper()),ss.video||(ss.video=document.createElement("video"),ss.video.style.setProperty("background-color","black"),ss.video.style.setProperty("width","100%"),ss.video.style.setProperty("height","100%"),ss.video.style.setProperty("opacity","0"),ss.video.setAttribute("controls","controls"),ss.videoWrapper.prepend(ss.video)),ss.videoWrapper.style.setProperty("visibility","visible"),posterUrl&&ss.video.setAttribute("poster",posterUrl),ss.video.setAttribute("src",url),ss.video.load(),ss.loaded="video"},VirtualSkySlideShow.prototype.showImage=function(url){this.planetarium.container.css({"background-color":"black","background-image":'url("'+url+'")',"background-position":"center","background-repeat":"no-repeat","background-size":"contain"}),this.planetarium.canvas.css({transition:"opacity 0.5s ease-in-out"}),this.planetarium.canvas.css({opacity:"0"}),this.show=!0},VirtualSkySlideShow.prototype.showVideo=function(url,posterUrl){var videoEnded,ss=this,transitionEnd=(ss.video||ss.loadVideo(url,posterUrl),function(){ss.video.removeEventListener("transitionend",transitionEnd),ss.video.play()});ss.video.addEventListener("transitionend",transitionEnd),ss.video.style.setProperty("transition","opacity 0.5s ease-in-out"),ss.video.style.setProperty("opacity","1"),ss.pause||(videoEnded=function(e){ss.video.removeEventListener("ended",videoEnded),ss.hideVideo(),setTimeout(function(){ss.showing=!1,ss.pause||ss.nextSlide(ss.startId,!1)},500)},ss.video.addEventListener("ended",videoEnded)),this.show=!0},VirtualSkySlideShow.prototype.hideMedia=function(url){"image"===this.loaded?this.hideImage():"video"===this.loaded&&this.hideVideo()},VirtualSkySlideShow.prototype.hideImage=function(){this.planetarium.canvas.css({opacity:"1"}),this.show=!1,this.loaded=null},VirtualSkySlideShow.prototype.hideVideo=function(){var transitionEnd,ss=this;ss.video&&(ss.video.addEventListener("transitionend",transitionEnd=function(){ss.video.removeEventListener("transitionend",transitionEnd),ss.videoWrapper.style.setProperty("visibility","hidden"),ss.video.pause(),ss.video.setAttribute("src",null)}),ss.video.style.setProperty("opacity","0")),ss.show=!1,this.loaded=null},VirtualSkySlideShow.prototype.nextSlide=function(startId,quick){this.slideIndex>=this.slides.length||(this.quick=quick,this.slideIndex++,this.slides.length<=this.slideIndex&&(this.pause=!0),this.moving)||this.showSlide(startId,this.slideIndex,quick)},VirtualSkySlideShow.prototype.prevSlide=function(startId,quick){this.slideIndex<0||(this.quick=quick,this.slideIndex--,this.slideIndex<0&&(this.pause=!0),this.moving)||this.showSlide(startId,this.slideIndex,quick)},VirtualSkySlideShow.prototype.showSlide=function(startId,index,quick){this.endZoom();var pan_duration,spin_duration,move_duration,stop_duration,next,show,pan,move,spin,ss=this,slide=ss.slides[index];slide?(pan_duration=quick?50:ss.config.pan_duration,spin_duration=quick?50:ss.config.spin_duration,move_duration=quick?50:ss.config.move_duration,stop_duration=quick?10:ss.config.stop_duration,next=function(){ss.showing=!1,ss.pause||ss.startId!=startId||ss.nextSlide(startId,!1)},show=function(){ss.moving=!1,setTimeout(function(){var lastIndex;index!=ss.slideIndex?(lastIndex=ss.slides.length-1,0<index&&ss.slideIndex<0?ss.showSlide(ss.startId,0,ss.quick):index<lastIndex&&ss.slideIndex>lastIndex?ss.showSlide(ss.startId,lastIndex,ss.quick):ss.showSlide(ss.startId,ss.slideIndex,ss.quick)):slide.video?ss.showVideo(slide.video,slide.poster):slide.image&&(ss.showImage(slide.image),ss.pause||setTimeout(next,ss.config.image_duration))},stop_duration)},pan=function(){slide.planet?ss.moveToPlanet(slide.planet,slide.label,pan_duration,show):ss.moveToRADec(slide.ra,slide.dec,slide.label,pan_duration,show)},move=function(){ss.moveToPos(slide.latitude,slide.longitude,move_duration,pan)},spin=function(){slide.video?ss.loadVideo(slide.video,slide.poster):slide.image&&ss.loadImage(slide.image),ss.planetarium.pointers=[];var f=slide.latitude===ss.planetarium.latitude.deg&&slide.longitude===ss.planetarium.longitude.deg?pan:move;ss.moveToClock(new Date(slide.date),spin_duration,f)},quick=function(){setTimeout(spin,stop_duration)},ss.moving=!0,ss.show?(setTimeout(quick,500),ss.hideMedia()):quick()):ss.show&&ss.hideMedia()},VirtualSkySlideShow.prototype.loadSlides=function(src,onLoad){var ss=this;"string"==typeof src?S(document).ajax(src,{dataType:"json",success:function(data){ss.init(data),onLoad&&onLoad()},complete:function(){},error:function(e){console.log("load error: "+e)}}):(ss.init(data),onLoad&&onLoad())},VirtualSkySlideShow.prototype.init=function(data){for(var p in this.config={date:"1970-01-01T00:00:00+00:00",latitude:35,longitude:139,az:180,spin_duration:1500,pan_duration:500,move_duration:500,stop_duration:1e3,image_duration:5e3},data.config)this.config[p]=data.config[p];this.slides=data.slides;this.config.latitude,this.config.longitude;for(var i=0;i<this.slides.length;i++){var s=this.slides[i];s.latitude||(s.latitude=this.config.latitude),s.longitude||(s.longitude=this.config.longitude)}this.slideIndex=-1},VirtualSkySlideShow.prototype.resetSlideShow=function(){this.planetarium.setLatitude(this.config.latitude),this.planetarium.setLongitude(this.config.longitude),this.planetarium.updateClock(new Date(this.config.date)),this.planetarium.az_off=this.config.az%360-180,this.planetarium.drawImmediate(),this.slideIndex=-1},VirtualSkySlideShow.prototype.startSlideShow=function(){this.resetSlideShow(),this.start()},VirtualSkySlideShow.prototype.renewStartId=function(){var oldId=this.startId;this.startId++,this.startId==oldId&&(this.startId=0)},VirtualSkySlideShow.prototype.start=function(){this.renewStartId(),this.nextSlide(this.startId,!1)},VirtualSkySlideShow.prototype.forward=function(){this.renewStartId(),this.nextSlide(this.startId,this.quick_with_key)},VirtualSkySlideShow.prototype.backward=function(){this.renewStartId(),this.prevSlide(this.startId,this.quick_with_key)},VirtualSkySlideShow.prototype.beginning=function(){this.renewStartId(),this.slideIndex=-1,this.showSlide(this.startId,0,this.quick)},VirtualSkySlideShow.prototype.end=function(){this.renewStartId(),this.slideIndex=this.slides.length,this.showSlide(this.startId,this.slides.length-1,this.quick)},VirtualSkySlideShow.prototype.toggleZoomMode=function(){this.zoomMode?this.endZoom():this.zoom()},VirtualSkySlideShow.prototype.zoom=function(){var slide=this.slides[this.slideIndex];null==this.wzoom||slide.video||(this.zoomMode=!0,this.zoomviewImage.setAttribute("src",this.slides[this.slideIndex].image),this.wzoom.prepare(),document.getElementById(ss.id).style.setProperty("visibility","hidden"),document.fullscreenElement&&this.zoomview.requestFullscreen(),this.zoomview.style.setProperty("z-index","100"),this.zoomview.style.setProperty("visibility","visible"),this.zoomview.focus())},VirtualSkySlideShow.prototype.endZoom=function(){null!=this.wzoom&&(document.fullscreenElement&&document.getElementById(ss.id).requestFullscreen(),this.zoomviewImage.setAttribute("src",""),this.zoomview.style.setProperty("visibility","hidden"),this.wzoom.prepare(),this.zoomMode=!1,document.getElementById(ss.id).style.setProperty("visibility","visible"),this.zoomview.style.setProperty("z-index","-100"),document.getElementById(ss.id).focus())},VirtualSkySlideShow.prototype.handleWheel=function(e){ss.zoomMode||e.deltaY<0&&ss.zoom()},VirtualSkySlideShow.prototype.handleKey=function(e){switch(e.key){case"ArrowRight":case"n":ss.pause=!0,ss.forward();break;case"ArrowLeft":case"p":ss.pause=!0,ss.backward();break;case"Home":case",":case"<":ss.pause=!0,ss.beginning();break;case"End":case".":case">":ss.pause=!0,ss.end();break;case"z":ss.pause=!0,ss.toggleZoomMode()}},VirtualSkySlideShow.prototype.resize=function(){var elm=document.getElementById(this.id),maxWidth=document.documentElement.clientWidth-elm.getBoundingClientRect().left,width=elm.clientWidth;elm.clientHeight;maxWidth<width&&(elm.style.backgroundSize=maxWidth+"px"),this.planetarium&&this.planetarium.resize(),this.show&&this.loadImage(this.slides[this.slideIndex].image)};
